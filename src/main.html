<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <style>
        .nav-link {
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div class="container">
        <ul class="nav nav-tabs">
            <!-- podemos cambiar a botones-->
            <li class="nav-item">
                <div class="nav-link active" id="edit-link">Home</div>
            </li>
            <li class="nav-item">
                <div class="nav-link" id="search-link">Buscar</div>
            </li>
            <li class="nav-item">
                <div class="nav-link" id="add-link">Añadir</div>
            </li>
        </ul>
        <div id="app"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
        integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
        integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
        crossorigin="anonymous"></script>

    <script>

        const COMPARE_ATRIBUTTES = ["id", "name", "region", "department", "period", "project", "campus"];
        var DATA;

        function loadView(options) {
            // Podemos cambiar por parñámetros predefinidos
            var id = typeof options.id === "undefined" ? "app" : options.id;
            var callback = typeof options.callback === "undefined" ? () => { } : options.callback;
            google.script.run.withSuccessHandler((html) => {
                document.getElementById(id).innerHTML = html;
                typeof options.params === "undefined" ? callback() : callback(options.params);
            })[options.func]();
        }

        function loadSearchView() {
            //Cambiar pestaña activa 
            loadView({ func: "loadSearchView", callback: setDataForSearch });
        }

        function loadAddVolunteerView() {
            //Cambiar pestaña activa 
            loadView({ func: "loadAddVolunteerView" });
        }

        function loadEditVolunteerView() {
            //Cambiar pestaña activa 
            loadView({ func: "loadEditVolunteerView" });
        }

        function setDataForSearch() {
            google.script.run.withSuccessHandler((dataReturned) => {
                DATA = dataReturned.slice();
            }).getDataForSearch();
        }

        function search() {
            //optimizar, juntar búqueda y despliegue
            var searchInput = document.getElementById("searchInput").value.toString().toLowerCase().trim();
            var searchWords = searchInput.split(/\s+/);
            // and condition

            var resultsArray = DATA.filter((volunteer) => {

                if (searchWords.every((word) => {
                    for (let atribute = 0; atribute < COMPARE_ATRIBUTTES.length; atribute++) {
                        if (volunteer[COMPARE_ATRIBUTTES[atribute]].toLowerCase().indexOf(word) != -1) return true;
                    }
                    return false;
                })) return true;

                return false;
            });

            var searchResultsBox = document.getElementById("searchResults");
            var template = document.getElementById("rowTemplate");
            searchResultsBox.innerHTML = "";
            if (searchInput === "") return;
            resultsArray.forEach((volunteer) => {
                var row = template.content.cloneNode(true);
                row.querySelector(".confirm-button").dataset.volunteerId = volunteer.id;
                for (let atribute = 0; atribute < COMPARE_ATRIBUTTES.length; atribute++) {
                    // Case sensitive?
                    row.querySelector("." + COMPARE_ATRIBUTTES[atribute]).textContent = volunteer[COMPARE_ATRIBUTTES[atribute]];
                }
                searchResultsBox.appendChild(row);
            });
        }

        function displayConfirmation(event){
            //orden en html: "confirmar", "-eliminar-", "cancelar"
            event.target.previousElementSibling.classList.remove("d-none"); //show confirm button
            event.target.nextElementSibling.classList.remove("d-none"); //show cancel button
            event.target.classList.add("d-none"); //hide delete button
        }

        function hideConfirmation(event){
            //orden en html: "confirmar", "eliminar", "-cancelar-"
            event.target.previousElementSibling.classList.remove("d-none"); //show delete button
            event.target.previousElementSibling.previousElementSibling.classList.add("d-none"); //hide confirm button
            event.target.classList.add("d-none"); //hide cancel button
        }

        function deleteVolunteer(event) {
            google.script.run.withSuccessHandler(() => {
                event.target.closest(".result-box").remove();
            }).deleteById(event.target.dataset.volunteerId);
        }

        function inputEventHandler(event) {
            if (event.target.matches("#searchInput")) search();
            if (event.target.matches(".delete-button")) displayConfirmation(event);
            if (event.target.matches(".confirm-button")) deleteVolunteer(event);
            if (event.target.matches(".cancel-button")) hideConfirmation(event);
        }

        document.getElementById("search-link").addEventListener("click", loadSearchView);
        document.getElementById("add-link").addEventListener("click", loadAddVolunteerView);
        document.getElementById("edit-link").addEventListener("click", loadEditVolunteerView);
        document.getElementById("app").addEventListener("input", inputEventHandler);
        document.getElementById("app").addEventListener("click", inputEventHandler);
    </script>
</body>

</html>